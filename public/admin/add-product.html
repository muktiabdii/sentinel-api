<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Add Product</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 800px; margin: 2rem auto; }
      input, textarea { display: block; width: 100%; margin-bottom: .5rem; padding: .5rem }
      label { font-weight: bold; margin-top: .75rem }
      img#preview { max-width: 200px; display:block; margin-top:.5rem }
    </style>
  </head>
  <body>
    <h1>Add Product</h1>

    <div>
      <label for="authToken">Auth Token (paste JWT here)</label>
      <input id="authToken" placeholder="Paste token here or set after login" />
      <button id="saveToken">Save token</button>
    </div>

    <form id="productForm">
      <label for="name">Name</label>
      <input id="name" required />

      <label for="description">Description</label>
      <textarea id="description"></textarea>

      <label for="price">Price</label>
      <input id="price" type="number" step="0.01" required />

      <label for="color">Color</label>
      <input id="color" />

      <label for="memory">Memory</label>
      <input id="memory" />

      <label for="image">Image (will upload directly to Cloudinary)</label>
      <input id="image" type="file" accept="image/*" />

      <input id="imageUrl" type="hidden" />
      <div id="progressWrapper" style="display:none; width:100%; background:#eee; border-radius:4px; overflow:hidden; margin-top:.5rem">
        <div id="uploadProgress" style="width:0%; height:18px; background:#4caf50; color:#fff; text-align:center; font-size:12px; line-height:18px;">0%</div>
      </div>
      <img id="preview" src="" alt="preview" style="display:none; max-width:200px; margin-top:.5rem" />

      <button type="submit">Create Product</button>
    </form>

    <hr />
    <h2>Products</h2>
    <div id="productsList">Loading products...</div>


    <script>
      async function getCloudConfig() {
        const res = await fetch('/api/config/cloudinary');
        if (!res.ok) throw new Error('Failed to fetch cloudinary config');
        return res.json();
      }

      document.getElementById('saveToken').addEventListener('click', (e) => {
        e.preventDefault();
        const t = document.getElementById('authToken').value.trim();
        if (t) { localStorage.setItem('authToken', t); alert('Token saved to localStorage'); }
      });

      (async function () {
        let cfg = null;
        try { cfg = await getCloudConfig(); } catch (e) { alert('Could not load Cloudinary config: ' + e.message); return; }

        const cloudName = cfg.name;
        const preset = cfg.preset;

        const fileInput = document.getElementById('image');
        fileInput.addEventListener('change', (ev) => {
          const file = ev.target.files[0];
          if (!file) return;

          const progressWrapper = document.getElementById('progressWrapper');
          const progressBar = document.getElementById('uploadProgress');
          const preview = document.getElementById('preview');
          preview.style.display = 'none';
          progressWrapper.style.display = 'block';
          progressBar.style.width = '0%';
          progressBar.textContent = '0%';

          const fd = new FormData();
          fd.append('file', file);
          fd.append('upload_preset', preset);

          const url = `https://api.cloudinary.com/v1_1/${cloudName}/upload`;
          const xhr = new XMLHttpRequest();
          xhr.open('POST', url);
          xhr.upload.onprogress = function (e) {
            if (e.lengthComputable) {
              const percent = Math.round((e.loaded / e.total) * 100);
              progressBar.style.width = percent + '%';
              progressBar.textContent = percent + '%';
            }
          };
          xhr.onload = function () {
            progressWrapper.style.display = 'none';
            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                const data = JSON.parse(xhr.responseText);
                if (data.secure_url) {
                  document.getElementById('imageUrl').value = data.secure_url;
                  preview.src = data.secure_url;
                  preview.style.display = 'block';
                } else {
                  console.error(data);
                  alert('Upload failed — check console for details');
                }
              } catch (err) {
                console.error(err);
                alert('Upload parse error');
              }
            } else {
              console.error(xhr.responseText);
              alert('Upload failed: ' + xhr.statusText);
            }
          };
          xhr.onerror = function () {
            progressWrapper.style.display = 'none';
            alert('Upload error');
          };
          xhr.send(fd);
        });

        const productsListEl = document.getElementById('productsList');

        async function fetchProducts() {
          productsListEl.textContent = 'Loading products...';
          try {
            const r = await fetch('/api/products');
            const json = await r.json();
            const products = json.products || [];
            if (products.length === 0) {
              productsListEl.innerHTML = '<em>No products yet</em>';
              return;
            }

            const rows = products.map(p => {
              return `
                <div style="display:flex;align-items:center;margin:8px 0;border:1px solid #ddd;padding:8px;border-radius:6px">
                  <img src="${p.image || ''}" style="width:80px;height:80px;object-fit:cover;margin-right:12px" />
                  <div style="flex:1">
                    <div style="font-weight:bold">${p.name}</div>
                    <div style="color:#666">${p.memory || ''} • ${p.color || ''}</div>
                    <div style="color:#111">Rp ${p.price || 0}</div>
                  </div>
                  <div>
                    <button data-id="${p.id}" class="deleteBtn" style="background:#e74c3c;color:#fff;border:none;padding:8px 10px;border-radius:4px;cursor:pointer">Delete</button>
                  </div>
                </div>
              `;
            }).join('');

            productsListEl.innerHTML = rows;

            // attach delete handlers
            document.querySelectorAll('.deleteBtn').forEach(btn => {
              btn.addEventListener('click', async (ev) => {
                const id = ev.currentTarget.getAttribute('data-id');
                if (!confirm('Delete this product?')) return;
                const token = localStorage.getItem('authToken') || '';
                try {
                  const r = await fetch(`/api/products/${id}`, {
                    method: 'DELETE',
                    headers: {
                      ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                  });
                  const res = await r.json();
                  if (r.ok) {
                    alert('Deleted');
                    fetchProducts();
                  } else {
                    alert('Delete failed: ' + (res.error || JSON.stringify(res)));
                  }
                } catch (err) {
                  console.error(err);
                  alert('Request failed');
                }
              });
            });
          } catch (err) {
            console.error(err);
            productsListEl.textContent = 'Failed to load products';
          }
        }

        // initial load
        fetchProducts();

        document.getElementById('productForm').addEventListener('submit', async (ev) => {
          ev.preventDefault();

          const payload = {
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            price: parseFloat(document.getElementById('price').value) || 0,
            color: document.getElementById('color').value,
            memory: document.getElementById('memory').value,
            image: document.getElementById('imageUrl').value
          };

          if (!payload.image) { alert('Please upload an image first'); return; }

          const token = localStorage.getItem('authToken') || '';

          try {
            const r = await fetch('/api/products', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
              },
              body: JSON.stringify(payload)
            });
            const res = await r.json();
            if (r.ok) {
              alert('Product created');
              console.log(res);
              // refresh list
              fetchProducts();
            } else {
              console.error(res);
              alert('Error creating product: ' + (res.error || JSON.stringify(res)));
            }
          } catch (err) {
            console.error(err);
            alert('Request failed');
          }
        });
      })();
    </script>
  </body>
</html>
