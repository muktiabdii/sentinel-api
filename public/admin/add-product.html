<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Add Product</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
      input, textarea { display: block; width: 100%; margin-bottom: .5rem; padding: .5rem; box-sizing: border-box; }
      label { font-weight: bold; margin-top: .75rem; display: block; }
      /* Style untuk preview banyak gambar */
      .preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: .5rem; }
      .preview-img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
      button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; margin-top: 10px; }
      .deleteBtn { background: #e74c3c; font-size: 12px; padding: 5px 10px; }
    </style>
  </head>
  <body>
    <h1>Add Product (Multi)</h1>

    <div>
      <label for="authToken">Auth Token (paste JWT here)</label>
      <input id="authToken" placeholder="Paste token here or set after login" />
      <button id="saveToken">Save token</button>
    </div>

    <form id="productForm">
      <label for="name">Name</label>
      <input id="name" required />

      <label for="sku">SKU (Unique)</label>
      <input id="sku" required placeholder="IP15-PRO" />

      <label for="description">Description</label>
      <textarea id="description"></textarea>

      <label for="price">Price</label>
      <input id="price" type="number" step="0.01" required />

      <!-- Input Multi Variant -->
      <label for="color">Color (Pisahkan dengan koma)</label>
      <input id="color" placeholder="Hitam, Putih, Biru" />

      <label for="memory">Memory (Pisahkan dengan koma)</label>
      <input id="memory" placeholder="128GB, 256GB" />

      <label for="warranty">Warranty (Months)</label>
      <input id="warranty" type="number" value="12" />

      <!-- Input Multi Image -->
      <label for="image">Images (Select multiple files)</label>
      <input id="image" type="file" accept="image/*" multiple />

      <!-- Preview Container -->
      <div id="progressWrapper" style="display:none; margin-top:.5rem; font-weight:bold; color:#4caf50;">
        Uploading... <span id="uploadCount">0</span> images done.
      </div>
      <div id="previewContainer" class="preview-container"></div>

      <button type="submit" id="submitBtn">Create Product</button>
    </form>

    <hr />
    <h2>Products</h2>
    <div id="productsList">Loading products...</div>

    <script>
      let uploadedImageUrls = []; // Penampung URL gambar

      // 1. Fetch Config Cloudinary
      async function getCloudConfig() {
        const res = await fetch('/api/config/cloudinary');
        if (!res.ok) throw new Error('Failed to fetch cloudinary config (Check backend route!)');
        return res.json();
      }

      document.getElementById('saveToken').addEventListener('click', (e) => {
        e.preventDefault();
        const t = document.getElementById('authToken').value.trim();
        if (t) { localStorage.setItem('authToken', t); alert('Token saved'); }
      });
      const savedToken = localStorage.getItem('authToken');
      if(savedToken) document.getElementById('authToken').value = savedToken;

      // Fungsi Helper Upload Promise
      function uploadFileToCloudinary(file, preset, cloudName) {
        return new Promise((resolve, reject) => {
          const fd = new FormData();
          fd.append('file', file);
          fd.append('upload_preset', preset);

          const xhr = new XMLHttpRequest();
          xhr.open('POST', `https://api.cloudinary.com/v1_1/${cloudName}/upload`);
          
          xhr.onload = function () {
            if (xhr.status >= 200 && xhr.status < 300) {
              const data = JSON.parse(xhr.responseText);
              resolve(data.secure_url);
            } else {
              reject(xhr.statusText);
            }
          };
          xhr.onerror = () => reject('Network Error');
          xhr.send(fd);
        });
      }

      (async function () {
        let cfg = null;
        try { 
            cfg = await getCloudConfig(); 
        } catch (e) { 
            alert('Error: ' + e.message + '\n\nPastikan route /api/config/cloudinary ada di backend!'); 
            return; 
        }

        const cloudName = cfg.name;
        const preset = cfg.preset;

        // 2. Handle File Selection (Multi Upload)
        const fileInput = document.getElementById('image');
        const previewContainer = document.getElementById('previewContainer');
        const progressWrapper = document.getElementById('progressWrapper');
        const uploadCountLabel = document.getElementById('uploadCount');
        const submitBtn = document.getElementById('submitBtn');

        fileInput.addEventListener('change', async (ev) => {
          const files = Array.from(ev.target.files);
          if (files.length === 0) return;

          // Reset UI
          uploadedImageUrls = [];
          previewContainer.innerHTML = '';
          progressWrapper.style.display = 'block';
          submitBtn.disabled = true;
          submitBtn.innerText = "Uploading Images...";

          try {
            const uploadPromises = files.map(async (file) => {
                const url = await uploadFileToCloudinary(file, preset, cloudName);
                
                // Update UI per file selesai
                const img = document.createElement('img');
                img.src = url;
                img.className = 'preview-img';
                previewContainer.appendChild(img);
                
                uploadedImageUrls.push(url);
                uploadCountLabel.innerText = uploadedImageUrls.length + "/" + files.length;
                return url;
            });

            await Promise.all(uploadPromises);
            
            submitBtn.disabled = false;
            submitBtn.innerText = "Create Product";
            progressWrapper.style.display = 'none';

          } catch (err) {
            console.error(err);
            alert('Upload Failed: ' + err);
            submitBtn.disabled = false;
          }
        });

        // 3. Load Products
        const productsListEl = document.getElementById('productsList');

        async function fetchProducts() {
          productsListEl.textContent = 'Loading products...';
          try {
            const r = await fetch('/api/products');
            const json = await r.json();
            // Backend baru return { success: true, data: [...] }
            const products = json.data || json.products || []; 
            
            if (products.length === 0) {
              productsListEl.innerHTML = '<em>No products yet</em>';
              return;
            }

            const rows = products.map(p => {
              // Handle Array Display
              const thumb = Array.isArray(p.image) ? p.image[0] : p.image;
              const colors = Array.isArray(p.color) ? p.color.join(', ') : p.color;
              const mems = Array.isArray(p.memory) ? p.memory.join(', ') : p.memory;

              return `
                <div style="display:flex;align-items:center;margin:8px 0;border:1px solid #ddd;padding:8px;border-radius:6px">
                  <img src="${thumb || ''}" style="width:80px;height:80px;object-fit:cover;margin-right:12px; border-radius:4px" />
                  <div style="flex:1">
                    <div style="font-weight:bold">${p.name}</div>
                    <div style="color:#666">${mems || '-'} â€¢ ${colors || '-'}</div>
                    <div style="color:#111">Rp ${parseInt(p.price).toLocaleString()}</div>
                  </div>
                  <div>
                    <button data-id="${p.id}" class="deleteBtn" style="color:white;border:none;border-radius:4px;cursor:pointer">Delete</button>
                  </div>
                </div>
              `;
            }).join('');

            productsListEl.innerHTML = rows;

            // Delete Handler
            document.querySelectorAll('.deleteBtn').forEach(btn => {
              btn.addEventListener('click', async (ev) => {
                const id = ev.currentTarget.getAttribute('data-id');
                if (!confirm('Delete?')) return;
                const token = localStorage.getItem('authToken') || '';
                try {
                  const r = await fetch(`/api/products/${id}`, {
                    method: 'DELETE',
                    headers: { ...(token ? { 'Authorization': `Bearer ${token}` } : {}) }
                  });
                  if (r.ok) fetchProducts();
                  else alert('Failed to delete');
                } catch (err) { alert('Request failed'); }
              });
            });
          } catch (err) {
            productsListEl.textContent = 'Failed to load products';
          }
        }

        fetchProducts();

        // 4. Submit Product
        document.getElementById('productForm').addEventListener('submit', async (ev) => {
          ev.preventDefault();

          if (uploadedImageUrls.length === 0) { 
            alert('Please upload images first'); return; 
          }

          // Parse Variant Strings to Array
          const colorStr = document.getElementById('color').value;
          const memStr = document.getElementById('memory').value;

          const payload = {
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            price: parseFloat(document.getElementById('price').value) || 0,
            sku: document.getElementById('sku').value,
            warranty_period_months: parseInt(document.getElementById('warranty').value) || 12,
            
            // Convert ke Array untuk Backend
            color: colorStr ? colorStr.split(',').map(s => s.trim()) : [],
            memory: memStr ? memStr.split(',').map(s => s.trim()) : [],
            
            // Kirim Array URL
            image: uploadedImageUrls 
          };

          const token = localStorage.getItem('authToken') || '';

          try {
            const r = await fetch('/api/products', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
              },
              body: JSON.stringify(payload)
            });
            const res = await r.json();
            
            if (r.ok) {
              alert('Product created!');
              document.getElementById('productForm').reset();
              uploadedImageUrls = [];
              document.getElementById('previewContainer').innerHTML = '';
              fetchProducts();
            } else {
              alert('Error: ' + (res.error || res.message || JSON.stringify(res)));
            }
          } catch (err) {
            console.error(err);
            alert('Request failed');
          }
        });
      })();
    </script>
  </body>
</html>