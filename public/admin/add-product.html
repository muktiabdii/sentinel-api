<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Add Product</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
      input, textarea { display: block; width: 100%; margin-bottom: .5rem; padding: .5rem; box-sizing: border-box; }
      label { font-weight: bold; margin-top: .75rem; display: block; }
      .preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: .5rem; }
      .preview-img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
      button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; }
      button:disabled { background: #ccc; }
      .deleteBtn { background: #dc3545; font-size: 12px; padding: 5px 10px; }
    </style>
  </head>
  <body>
    <h1>Add Product (Multi Variant)</h1>

    <div>
      <label for="authToken">Auth Token (paste JWT here)</label>
      <input id="authToken" placeholder="Paste token here or set after login" />
      <button id="saveToken">Save token</button>
    </div>

    <form id="productForm">
      <label for="name">Name</label>
      <input id="name" required placeholder="e.g. iPhone 15 Pro" />

      <label for="sku">SKU (Unique ID)</label>
      <input id="sku" required placeholder="e.g. IP15-PRO" />

      <label for="description">Description</label>
      <textarea id="description"></textarea>

      <label for="price">Price</label>
      <input id="price" type="number" step="0.01" required />

      <label for="color">Colors (Separate with comma)</label>
      <input id="color" placeholder="Black, Blue, Natural Titanium" />

      <label for="memory">Memory (Separate with comma)</label>
      <input id="memory" placeholder="128GB, 256GB, 512GB" />

      <label for="warranty">Warranty (Months)</label>
      <input id="warranty" type="number" value="12" />

      <!-- MULTIPLE FILE INPUT -->
      <label for="image">Images (Select multiple)</label>
      <input id="image" type="file" accept="image/*" multiple />

      <!-- Progress & Preview -->
      <div id="progressWrapper" style="display:none; width:100%; background:#eee; border-radius:4px; overflow:hidden; margin-top:.5rem">
        <div id="uploadProgress" style="width:0%; height:18px; background:#4caf50; color:#fff; text-align:center; font-size:12px; line-height:18px;">0%</div>
      </div>
      <div id="previewContainer" class="preview-container"></div>

      <br>
      <button type="submit" id="submitBtn">Create Product</button>
    </form>

    <hr />
    <h2>Products List</h2>
    <div id="productsList">Loading products...</div>

    <script>
      // Auto-detect URL (Local vs Vercel)
      const BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000/api' : '/api';
      
      // Array untuk menyimpan URL gambar yang sudah diupload
      let uploadedImageUrls = [];

      document.getElementById('saveToken').addEventListener('click', (e) => {
        e.preventDefault();
        const t = document.getElementById('authToken').value.trim();
        if (t) { localStorage.setItem('authToken', t); alert('Token saved to localStorage'); }
      });

      (async function () {
        
        // 1. Handle File Selection & Upload
        const fileInput = document.getElementById('image');
        const previewContainer = document.getElementById('previewContainer');
        const progressWrapper = document.getElementById('progressWrapper');
        const progressBar = document.getElementById('uploadProgress');
        const submitBtn = document.getElementById('submitBtn');

        fileInput.addEventListener('change', async (ev) => {
          const files = Array.from(ev.target.files);
          if (files.length === 0) return;

          // Reset state
          uploadedImageUrls = []; 
          previewContainer.innerHTML = '';
          progressWrapper.style.display = 'block';
          submitBtn.disabled = true;
          submitBtn.innerText = "Uploading images...";

          try {
            // A. Minta Signature ke Backend (Sekali saja cukup untuk batch ini)
            const signRes = await fetch(`${BASE_URL}/upload/signature`);
            const signData = await signRes.json();
            
            if (!signData.success) throw new Error("Failed to get signature");
            const { signature, timestamp, cloudName, apiKey, folder } = signData.payload;

            let completedCount = 0;

            // B. Upload setiap file secara paralel
            const uploadPromises = files.map(async (file) => {
              const fd = new FormData();
              fd.append('file', file);
              fd.append('api_key', apiKey);
              fd.append('timestamp', timestamp);
              fd.append('signature', signature);
              fd.append('folder', folder);

              const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                method: 'POST',
                body: fd
              });
              
              const data = await res.json();
              if (data.secure_url) {
                // Update Progress UI
                completedCount++;
                const percent = Math.round((completedCount / files.length) * 100);
                progressBar.style.width = percent + '%';
                progressBar.textContent = percent + '%';

                // Tampilkan Preview
                const img = document.createElement('img');
                img.src = data.secure_url;
                img.className = 'preview-img';
                previewContainer.appendChild(img);

                return data.secure_url;
              } else {
                throw new Error('Upload failed for one image');
              }
            });

            // Tunggu semua selesai
            uploadedImageUrls = await Promise.all(uploadPromises);
            console.log("Uploaded URLs:", uploadedImageUrls);
            
            submitBtn.disabled = false;
            submitBtn.innerText = "Create Product";

          } catch (err) {
            console.error(err);
            alert('Error uploading images: ' + err.message);
            submitBtn.disabled = false;
            submitBtn.innerText = "Create Product";
          }
        });

        // 2. Load Products List
        const productsListEl = document.getElementById('productsList');

        async function fetchProducts() {
          productsListEl.textContent = 'Loading products...';
          try {
            const r = await fetch(`${BASE_URL}/products`);
            const json = await r.json();
            const products = json.data || []; // Sesuai response controller kamu (json.data)
            
            if (products.length === 0) {
              productsListEl.innerHTML = '<em>No products yet</em>';
              return;
            }

            const rows = products.map(p => {
              // Ambil gambar pertama jika array, atau string jika single
              const thumb = Array.isArray(p.image) ? p.image[0] : p.image;
              const colors = Array.isArray(p.color) ? p.color.join(', ') : p.color;
              const mems = Array.isArray(p.memory) ? p.memory.join(', ') : p.memory;

              return `
                <div style="display:flex;align-items:center;margin:8px 0;border:1px solid #ddd;padding:8px;border-radius:6px">
                  <img src="${thumb || ''}" style="width:80px;height:80px;object-fit:cover;margin-right:12px" />
                  <div style="flex:1">
                    <div style="font-weight:bold">${p.name}</div>
                    <div style="color:#666; font-size: 0.9em;">Color: ${colors || '-'} | Mem: ${mems || '-'}</div>
                    <div style="color:#111; font-weight:500;">Rp ${parseInt(p.price).toLocaleString()}</div>
                  </div>
                  <div>
                    <button data-id="${p.id}" class="deleteBtn">Delete</button>
                  </div>
                </div>
              `;
            }).join('');

            productsListEl.innerHTML = rows;

            // Attach delete handlers
            document.querySelectorAll('.deleteBtn').forEach(btn => {
              btn.addEventListener('click', async (ev) => {
                const id = ev.currentTarget.getAttribute('data-id');
                if (!confirm('Delete this product?')) return;
                
                const token = localStorage.getItem('authToken') || '';
                try {
                  const r = await fetch(`${BASE_URL}/products/${id}`, {
                    method: 'DELETE',
                    headers: {
                      ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                    }
                  });
                  const res = await r.json();
                  if (r.ok) {
                    alert('Deleted');
                    fetchProducts();
                  } else {
                    alert('Delete failed: ' + (res.error || JSON.stringify(res)));
                  }
                } catch (err) {
                  console.error(err);
                  alert('Request failed');
                }
              });
            });
          } catch (err) {
            console.error(err);
            productsListEl.textContent = 'Failed to load products';
          }
        }

        // Initial Load
        fetchProducts();

        // 3. Handle Submit Form
        document.getElementById('productForm').addEventListener('submit', async (ev) => {
          ev.preventDefault();

          if (uploadedImageUrls.length === 0) { 
            alert('Please select and upload images first'); 
            return; 
          }

          // Ubah input "Merah, Biru" menjadi Array ["Merah", "Biru"]
          const colorStr = document.getElementById('color').value;
          const memoryStr = document.getElementById('memory').value;

          const payload = {
            name: document.getElementById('name').value,
            sku: document.getElementById('sku').value,
            description: document.getElementById('description').value,
            price: parseFloat(document.getElementById('price').value) || 0,
            warranty_period_months: parseInt(document.getElementById('warranty').value) || 12,
            
            // Convert Comma Separated String to Array
            color: colorStr.split(',').map(s => s.trim()).filter(s => s),
            memori: memoryStr.split(',').map(s => s.trim()).filter(s => s),
            
            // Kirim Array URL
            image: uploadedImageUrls 
          };

          const token = localStorage.getItem('authToken') || '';

          try {
            const r = await fetch(`${BASE_URL}/products`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
              },
              body: JSON.stringify(payload)
            });
            const res = await r.json();
            
            if (r.ok) {
              alert('Product created successfully!');
              // Reset form
              document.getElementById('productForm').reset();
              uploadedImageUrls = [];
              previewContainer.innerHTML = '';
              progressBar.style.width = '0%';
              
              fetchProducts();
            } else {
              console.error(res);
              alert('Error creating product: ' + (res.message || JSON.stringify(res)));
            }
          } catch (err) {
            console.error(err);
            alert('Request failed');
          }
        });
      })();
    </script>
  </body>
</html>