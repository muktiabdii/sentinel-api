<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Add Product</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
      input, textarea { display: block; width: 100%; margin-bottom: .5rem; padding: .5rem; box-sizing: border-box; }
      label { font-weight: bold; margin-top: .75rem; display: block; }
      /* CSS Preview untuk banyak gambar */
      .preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: .5rem; }
      .preview-img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
      button { padding: 10px 20px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 16px; margin-top: 10px;}
      button:disabled { background: #ccc; }
      .deleteBtn { background: #dc3545; font-size: 12px; padding: 5px 10px; }
    </style>
  </head>
  <body>
    <h1>Add Product (Multi Variant)</h1>

    <div>
      <label for="authToken">Auth Token (paste JWT here)</label>
      <input id="authToken" placeholder="Paste token here or set after login" />
      <button id="saveToken">Save token</button>
    </div>

    <form id="productForm">
      <label for="name">Name</label>
      <input id="name" required />

      <label for="sku">SKU</label>
      <input id="sku" required placeholder="Unique Code" />

      <label for="description">Description</label>
      <textarea id="description"></textarea>

      <label for="price">Price</label>
      <input id="price" type="number" step="0.01" required />

      <!-- Update Placeholder -->
      <label for="color">Colors (Pisahkan dengan koma)</label>
      <input id="color" placeholder="Merah, Biru, Hijau" />

      <label for="memory">Memory (Pisahkan dengan koma)</label>
      <input id="memory" placeholder="128GB, 256GB" />

      <label for="warranty">Warranty (Months)</label>
      <input id="warranty" type="number" value="12" />

      <!-- TAMBAHKAN 'multiple' DISINI -->
      <label for="image">Images (Select multiple files)</label>
      <input id="image" type="file" accept="image/*" multiple />

      <!-- Progress & Preview Container -->
      <div id="progressWrapper" style="display:none; width:100%; background:#eee; border-radius:4px; overflow:hidden; margin-top:.5rem">
        <div id="uploadProgress" style="width:0%; height:18px; background:#4caf50; color:#fff; text-align:center; font-size:12px; line-height:18px;">0%</div>
      </div>
      <div id="previewContainer" class="preview-container"></div>

      <button type="submit" id="submitBtn">Create Product</button>
    </form>

    <hr />
    <h2>Products List</h2>
    <div id="productsList">Loading products...</div>

    <script>
      // 1. AUTO DETECT BASE URL (Biar gak error 404 di Vercel)
      const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      const BASE_URL = isLocal ? 'http://localhost:5000/api' : '/api';

      // Variable untuk menyimpan URL hasil upload
      let uploadedImageUrls = [];

      document.getElementById('saveToken').addEventListener('click', (e) => {
        e.preventDefault();
        const t = document.getElementById('authToken').value.trim();
        if (t) { localStorage.setItem('authToken', t); alert('Token saved to localStorage'); }
      });
      
      // Load token saat refresh
      const savedToken = localStorage.getItem('authToken');
      if(savedToken) document.getElementById('authToken').value = savedToken;

      (async function () {
        
        // --- LOGIC BARU: SIGNED UPLOAD + MULTI FILE ---
        const fileInput = document.getElementById('image');
        const progressWrapper = document.getElementById('progressWrapper');
        const progressBar = document.getElementById('uploadProgress');
        const previewContainer = document.getElementById('previewContainer');
        const submitBtn = document.getElementById('submitBtn');

        fileInput.addEventListener('change', async (ev) => {
          const files = Array.from(ev.target.files);
          if (files.length === 0) return;

          // Reset UI
          uploadedImageUrls = [];
          previewContainer.innerHTML = '';
          progressWrapper.style.display = 'block';
          progressBar.style.width = '0%';
          progressBar.textContent = '0%';
          submitBtn.disabled = true;
          submitBtn.textContent = "Uploading...";

          try {
            // 1. Minta Signature ke Backend (GANTI dari /config/cloudinary ke /upload/signature)
            // Ini yang bikin error "Unexpected token <" sebelumnya hilang
            const signRes = await fetch(`${BASE_URL}/upload/signature`);
            const signData = await signRes.json();
            
            if (!signData.success) throw new Error("Failed to get signature");
            const { signature, timestamp, cloudName, apiKey, folder } = signData.payload;

            let completedCount = 0;

            // 2. Upload Loop untuk setiap file
            const uploadPromises = files.map(async (file) => {
              const fd = new FormData();
              fd.append('file', file);
              fd.append('api_key', apiKey);
              fd.append('timestamp', timestamp);
              fd.append('signature', signature);
              fd.append('folder', folder);

              const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                method: 'POST',
                body: fd
              });
              const data = await res.json();

              if (data.secure_url) {
                // Update Progress Bar
                completedCount++;
                const percent = Math.round((completedCount / files.length) * 100);
                progressBar.style.width = percent + '%';
                progressBar.textContent = percent + '%';

                // Tampilkan Preview Kecil
                const img = document.createElement('img');
                img.src = data.secure_url;
                img.className = 'preview-img';
                previewContainer.appendChild(img);

                return data.secure_url;
              } else {
                throw new Error('Upload failed');
              }
            });

            // Tunggu semua selesai
            uploadedImageUrls = await Promise.all(uploadPromises);
            console.log("Uploaded URLs:", uploadedImageUrls);
            
            submitBtn.disabled = false;
            submitBtn.textContent = "Create Product";

          } catch (err) {
            console.error(err);
            alert('Upload Error: ' + err.message);
            submitBtn.disabled = false;
          }
        });

        // --- LOAD PRODUCTS ---
        const productsListEl = document.getElementById('productsList');

        async function fetchProducts() {
          productsListEl.textContent = 'Loading products...';
          try {
            const r = await fetch(`${BASE_URL}/products`);
            const json = await r.json();
            
            // PERBAIKAN: Ambil dari json.data
            const products = json.data || []; 
            
            if (products.length === 0) {
              productsListEl.innerHTML = '<em>No products yet</em>';
              return;
            }

            const rows = products.map(p => {
              // Handle Array Display
              const thumb = Array.isArray(p.image) ? p.image[0] : p.image;
              const colors = Array.isArray(p.color) ? p.color.join(', ') : p.color;
              const mems = Array.isArray(p.memory) ? p.memory.join(', ') : p.memory;

              return `
                <div style="display:flex;align-items:center;margin:8px 0;border:1px solid #ddd;padding:8px;border-radius:6px">
                  <img src="${thumb || ''}" style="width:80px;height:80px;object-fit:cover;margin-right:12px" />
                  <div style="flex:1">
                    <div style="font-weight:bold">${p.name}</div>
                    <div style="color:#666">${mems || '-'} â€¢ ${colors || '-'}</div>
                    <div style="color:#111">Rp ${parseInt(p.price).toLocaleString()}</div>
                  </div>
                  <div>
                    <button data-id="${p.id}" class="deleteBtn" style="background:#e74c3c;color:#fff;border:none;padding:8px 10px;border-radius:4px;cursor:pointer">Delete</button>
                  </div>
                </div>
              `;
            }).join('');

            productsListEl.innerHTML = rows;

            // Attach Delete
            document.querySelectorAll('.deleteBtn').forEach(btn => {
              btn.addEventListener('click', async (ev) => {
                const id = ev.currentTarget.getAttribute('data-id');
                if (!confirm('Delete?')) return;
                const token = localStorage.getItem('authToken') || '';
                try {
                  const r = await fetch(`${BASE_URL}/products/${id}`, {
                    method: 'DELETE',
                    headers: { ...(token ? { 'Authorization': `Bearer ${token}` } : {}) }
                  });
                  const res = await r.json();
                  if (r.ok) { fetchProducts(); } 
                  else { alert('Delete failed: ' + (res.error || JSON.stringify(res))); }
                } catch (err) { alert('Request failed'); }
              });
            });
          } catch (err) {
            console.error(err);
            productsListEl.textContent = 'Failed to load products';
          }
        }

        fetchProducts();

        // --- SUBMIT FORM ---
        document.getElementById('productForm').addEventListener('submit', async (ev) => {
          ev.preventDefault();

          if (uploadedImageUrls.length === 0) { 
            alert('Please upload images first'); return; 
          }

          // Logic Baru: Pecah String jadi Array
          const colorStr = document.getElementById('color').value;
          const memoryStr = document.getElementById('memory').value;

          const payload = {
            name: document.getElementById('name').value,
            sku: document.getElementById('sku').value,
            description: document.getElementById('description').value,
            price: parseFloat(document.getElementById('price').value) || 0,
            warranty_period_months: parseInt(document.getElementById('warranty').value) || 12,
            
            // Convert ke Array
            color: colorStr ? colorStr.split(',').map(s => s.trim()) : [],
            memori: memoryStr ? memoryStr.split(',').map(s => s.trim()) : [],
            
            // Kirim Array URL Gambar
            image: uploadedImageUrls 
          };

          const token = localStorage.getItem('authToken') || '';

          try {
            const r = await fetch(`${BASE_URL}/products`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
              },
              body: JSON.stringify(payload)
            });
            const res = await r.json();
            
            if (r.ok) {
              alert('Product created');
              // Reset Form UI
              document.getElementById('productForm').reset();
              uploadedImageUrls = [];
              previewContainer.innerHTML = '';
              progressBar.style.width = '0%';
              
              fetchProducts();
            } else {
              console.error(res);
              alert('Error: ' + (res.message || JSON.stringify(res)));
            }
          } catch (err) {
            console.error(err);
            alert('Request failed');
          }
        });
      })();
    </script>
  </body>
</html>