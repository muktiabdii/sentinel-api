<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Add Product</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 900px; margin: 2rem auto; }
      input, textarea { display: block; width: 100%; margin-bottom: .5rem; padding: .5rem }
      label { font-weight: bold; margin-top: .75rem }
      .img-prev { width:120px; height:120px; object-fit:cover; margin:6px; border:1px solid #ddd; border-radius:8px }
    </style>
  </head>
  <body>
    <h1>Add Product</h1>

    <div>
      <label for="authToken">Auth Token (paste JWT here)</label>
      <input id="authToken" placeholder="Paste token here or set after login" />
      <button id="saveToken">Save token</button>
    </div>

    <form id="productForm">

      <label>Name</label>
      <input id="name" required />

      <label>Description</label>
      <textarea id="description"></textarea>

      <label>Price</label>
      <input id="price" type="number" step="0.01" required />

      <label>Color (comma separated)</label>
      <input id="color" placeholder="red, black, blue" />

      <label>Memory (comma separated)</label>
      <input id="memory" placeholder="64GB, 128GB, 256GB" />

      <label>Images (multiple upload)</label>
      <input id="images" type="file" accept="image/*" multiple />

      <div id="previewContainer" style="display:flex;flex-wrap:wrap;margin-top:10px"></div>

      <button type="submit">Create Product</button>
    </form>

    <hr />
    <h2>Products</h2>
    <div id="productsList">Loading products...</div>

    <script>
      async function getConfig() {
        const r = await fetch('/api/config/cloudinary');
        return r.json();
      }

      document.getElementById('saveToken').onclick = () => {
        localStorage.setItem('authToken', document.getElementById('authToken').value.trim());
        alert('Token saved');
      };

      (async () => {
        const cfg = await getConfig();
        const cloudName = cfg.name;
        const preset = cfg.preset;

        const imagesInput = document.getElementById('images');
        const previewContainer = document.getElementById('previewContainer');
        let uploadedImages = [];

        imagesInput.addEventListener('change', async (ev) => {
          const files = ev.target.files;
          uploadedImages = [];
          previewContainer.innerHTML = "";

          for (const file of files) {
            const fd = new FormData();
            fd.append('file', file);
            fd.append('upload_preset', preset);

            const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
              method: 'POST',
              body: fd
            });

            const data = await res.json();
            if (data.secure_url) {
              uploadedImages.push(data.secure_url);

              const img = document.createElement('img');
              img.src = data.secure_url;
              img.className = "img-prev";
              previewContainer.appendChild(img);
            }
          }
        });

        async function fetchProducts() {
          const r = await fetch('/api/products');
          const data = await r.json();
          const list = document.getElementById('productsList');

          list.innerHTML = data.products
            .map(p => `
              <div style="display:flex;border:1px solid #ddd;padding:10px;margin-bottom:8px">
                <img src="${p.images?.[0] || ''}" style="width:80px;height:80px;object-fit:cover;margin-right:12px" />
                <div style="flex:1">
                  <b>${p.name}</b><br>
                  <small>${(p.memory||[]).join(', ')} â€¢ ${(p.color||[]).join(', ')}</small><br>
                  <b>Rp ${p.price}</b>
                </div>
              </div>
            `)
            .join('');
        }
        fetchProducts();

        document.getElementById('productForm').onsubmit = async (ev) => {
          ev.preventDefault();

          const payload = {
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            price: Number(document.getElementById('price').value),
            color: document.getElementById('color').value.split(',').map(x => x.trim()).filter(Boolean),
            memory: document.getElementById('memory').value.split(',').map(x => x.trim()).filter(Boolean),
            images: uploadedImages
          };

          if (payload.images.length === 0) {
            alert("Upload at least 1 image");
            return;
          }

          const token = localStorage.getItem('authToken') || "";

          const r = await fetch('/api/products', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(token ? { Authorization: `Bearer ${token}` } : {})
            },
            body: JSON.stringify(payload)
          });

          const res = await r.json();
          if (r.ok) {
            alert('Product created');
            fetchProducts();
          } else {
            alert('Error: ' + res.error);
          }
        };
      })();
    </script>
  </body>
</html>
