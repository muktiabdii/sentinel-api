<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin - Add Product</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Tambahan CSS sedikit biar rapi */
      .preview-img { object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen font-sans p-8">
    
    <div class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-lg">
      <h1 class="text-2xl font-bold mb-6 text-gray-800">Sentinel Admin</h1>

      <div>
        <label class="block text-sm font-bold mb-1">Auth Token</label>
        <div class="flex gap-2 mb-4">
            <input id="authToken" class="border p-2 rounded w-full" placeholder="Paste token here" />
            <button id="saveToken" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
        </div>
      </div>

      <form id="productForm" class="space-y-4">
        <div>
            <label class="block text-sm font-bold">Name</label>
            <input id="name" required class="border p-2 rounded w-full" placeholder="iPhone 15 Pro" />
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-bold">SKU</label>
                <input id="sku" required class="border p-2 rounded w-full" placeholder="IP15-PRO" />
            </div>
            <div>
                <label class="block text-sm font-bold">Price</label>
                <input id="price" type="number" required class="border p-2 rounded w-full" />
            </div>
        </div>

        <div>
            <label class="block text-sm font-bold">Description</label>
            <textarea id="description" class="border p-2 rounded w-full"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-bold">Colors (Comma separated)</label>
                <input id="color" class="border p-2 rounded w-full" placeholder="Red, Blue" />
            </div>
            <div>
                <label class="block text-sm font-bold">Memory (Comma separated)</label>
                <input id="memory" class="border p-2 rounded w-full" placeholder="128GB, 256GB" />
            </div>
        </div>

        <div>
            <label class="block text-sm font-bold">Warranty (Months)</label>
            <input id="warranty" type="number" value="12" class="border p-2 rounded w-full" />
        </div>

        <div>
            <label class="block text-sm font-bold">Images (Multiple)</label>
            <input id="image" type="file" accept="image/*" multiple class="border p-2 rounded w-full" />
            
            <!-- Progress Bar -->
            <div id="progressWrapper" class="hidden w-full bg-gray-200 rounded-full h-4 mt-2">
                <div id="uploadProgress" class="bg-green-600 h-4 rounded-full text-xs text-white text-center" style="width: 0%">0%</div>
            </div>
            
            <!-- Preview Container -->
            <div id="previewContainer" class="flex gap-2 mt-2 flex-wrap"></div>
        </div>

        <button type="submit" id="submitBtn" class="w-full bg-green-600 text-white p-3 rounded font-bold hover:bg-green-700">Create Product</button>
      </form>

      <hr class="my-8" />
      
      <h2 class="text-xl font-bold mb-4">Products List</h2>
      <div id="productsList" class="space-y-2">Loading products...</div>
    </div>

    <script>
      // 1. Setup Base URL yang Benar
      const BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000/api' : '/api';
      
      let uploadedImageUrls = [];

      // Save Token Helper
      document.getElementById('saveToken').addEventListener('click', (e) => {
        e.preventDefault();
        const t = document.getElementById('authToken').value.trim();
        if (t) { localStorage.setItem('authToken', t); alert('Token saved!'); }
      });

      // Load Token on Start
      const savedToken = localStorage.getItem('authToken');
      if(savedToken) document.getElementById('authToken').value = savedToken;

      (async function () {
        
        // --- UPLOAD LOGIC ---
        const fileInput = document.getElementById('image');
        const previewContainer = document.getElementById('previewContainer');
        const progressWrapper = document.getElementById('progressWrapper');
        const progressBar = document.getElementById('uploadProgress');
        const submitBtn = document.getElementById('submitBtn');

        fileInput.addEventListener('change', async (ev) => {
          const files = Array.from(ev.target.files);
          if (files.length === 0) return;

          uploadedImageUrls = []; 
          previewContainer.innerHTML = '';
          progressWrapper.classList.remove('hidden');
          submitBtn.disabled = true;
          submitBtn.innerText = "Uploading images...";

          try {
            // Minta Signature
            const signRes = await fetch(`${BASE_URL}/upload/signature`);
            const signData = await signRes.json();
            if (!signData.success) throw new Error("Failed to get signature");
            
            const { signature, timestamp, cloudName, apiKey, folder } = signData.payload;
            let completedCount = 0;

            // Upload Parallel
            const uploadPromises = files.map(async (file) => {
              const fd = new FormData();
              fd.append('file', file);
              fd.append('api_key', apiKey);
              fd.append('timestamp', timestamp);
              fd.append('signature', signature);
              fd.append('folder', folder);

              const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, { method: 'POST', body: fd });
              const data = await res.json();
              
              if (data.secure_url) {
                completedCount++;
                const percent = Math.round((completedCount / files.length) * 100);
                progressBar.style.width = percent + '%';
                progressBar.textContent = percent + '%';

                const img = document.createElement('img');
                img.src = data.secure_url;
                img.className = 'w-20 h-20 object-cover rounded border';
                previewContainer.appendChild(img);
                return data.secure_url;
              }
              throw new Error('Upload failed');
            });

            uploadedImageUrls = await Promise.all(uploadPromises);
            submitBtn.disabled = false;
            submitBtn.innerText = "Create Product";

          } catch (err) {
            console.error(err);
            alert('Error uploading: ' + err.message);
            submitBtn.disabled = false;
          }
        });

        // --- FETCH PRODUCTS LOGIC ---
        const productsListEl = document.getElementById('productsList');

        async function fetchProducts() {
          productsListEl.textContent = 'Loading products...';
          try {
            const r = await fetch(`${BASE_URL}/products`);
            const json = await r.json();
            
            // ðŸ‘‡ PERBAIKAN UTAMA DISINI: Ganti json.products jadi json.data
            const products = json.data || []; 
            
            if (products.length === 0) {
              productsListEl.innerHTML = '<em class="text-gray-500">No products yet</em>';
              return;
            }

            const rows = products.map(p => {
              // Handle Array/String image
              const thumb = Array.isArray(p.image) ? p.image[0] : p.image;
              
              // Handle Array Colors/Memory untuk tampilan
              // Cek apakah data dari DB itu array atau string
              const colorDisplay = Array.isArray(p.color) ? p.color.join(', ') : p.color;
              const memoryDisplay = Array.isArray(p.memory) ? p.memory.join(', ') : p.memory;

              return `
                <div class="flex items-center border p-3 rounded bg-gray-50">
                  <img src="${thumb || ''}" class="w-16 h-16 object-cover rounded mr-4 bg-gray-200" />
                  <div class="flex-1">
                    <div class="font-bold text-lg">${p.name}</div>
                    <div class="text-sm text-gray-600">${memoryDisplay || '-'} â€¢ ${colorDisplay || '-'}</div>
                    <div class="text-blue-600 font-medium">Rp ${parseInt(p.price).toLocaleString()}</div>
                  </div>
                  <button data-id="${p.id}" class="deleteBtn bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">Delete</button>
                </div>
              `;
            }).join('');

            productsListEl.innerHTML = rows;

            // Attach Delete Handlers
            document.querySelectorAll('.deleteBtn').forEach(btn => {
              btn.addEventListener('click', async (ev) => {
                const id = ev.currentTarget.getAttribute('data-id');
                if (!confirm('Delete this product?')) return;
                
                const token = localStorage.getItem('authToken') || '';
                try {
                  const r = await fetch(`${BASE_URL}/products/${id}`, {
                    method: 'DELETE',
                    headers: { ...(token ? { 'Authorization': `Bearer ${token}` } : {}) }
                  });
                  const res = await r.json();
                  if (r.ok) { fetchProducts(); } 
                  else { alert('Delete failed: ' + (res.error || JSON.stringify(res))); }
                } catch (err) { alert('Request failed'); }
              });
            });

          } catch (err) {
            console.error(err);
            productsListEl.textContent = 'Failed to load products. Check console.';
          }
        }

        // Initial Load
        fetchProducts();

        // --- SUBMIT FORM LOGIC ---
        document.getElementById('productForm').addEventListener('submit', async (ev) => {
          ev.preventDefault();

          if (uploadedImageUrls.length === 0) { 
            alert('Please select and upload images first'); 
            return; 
          }

          const colorVal = document.getElementById('color').value;
          const memVal = document.getElementById('memory').value;

          const payload = {
            name: document.getElementById('name').value,
            sku: document.getElementById('sku').value,
            description: document.getElementById('description').value,
            price: parseFloat(document.getElementById('price').value) || 0,
            warranty_period_months: parseInt(document.getElementById('warranty').value) || 12,
            
            // Convert String "A, B" -> Array ["A", "B"]
            color: colorVal ? colorVal.split(',').map(s => s.trim()) : [],
            memori: memVal ? memVal.split(',').map(s => s.trim()) : [],
            
            image: uploadedImageUrls 
          };

          const token = localStorage.getItem('authToken') || '';

          try {
            const r = await fetch(`${BASE_URL}/products`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
              },
              body: JSON.stringify(payload)
            });
            const res = await r.json();
            
            if (r.ok) {
              alert('Product created successfully!');
              document.getElementById('productForm').reset();
              uploadedImageUrls = [];
              previewContainer.innerHTML = '';
              progressBar.style.width = '0%';
              fetchProducts(); // Refresh list
            } else {
              alert('Error: ' + (res.message || JSON.stringify(res)));
            }
          } catch (err) {
            alert('Request failed');
          }
        });

      })();
    </script>
  </body>
</html>